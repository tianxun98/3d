!function(x,v,g){"use strict";var X="ht",m=x[X],T=m.Default,L=T.def,$=T.getInternal();m.HistoryManager=function(z){this._histories=[],this.setDataModel(z)},L(m.HistoryManager,v,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var A=this;A._betweenTransaction++,1===A._betweenTransaction&&(A._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var T=this,w=T._histories;T._betweenTransaction>0&&T._betweenTransaction--,0===T._betweenTransaction&&(T._transactionHistories&&T._transactionHistories.length&&(w=w.slice(0,T._historyIndex+1),w.push(T._transactionHistories),w.length>T._maxHistoryCount&&(w=w.slice(w.length-T._maxHistoryCount)),T.setHistories(w),T.setHistoryIndex(w.length-1,!0)),delete T._transactionHistories)}},setDataModel:function(o){var e=this,l=e._dataModel;l!==o&&(l&&(delete l._historyManager,l.ump(e.handleDataModelPropertyChange,e),l.umm(e.$5p,e),l.umd(e.$6p,e),l.removeHierarchyChangeListener(e.handleHierarchyChange,e),l.removeIndexChangeListener(e.handleIndexChange,e)),e._dataModel=o,o&&(o._historyManager=e,o.mp(e.handleDataModelPropertyChange,e),o.mm(e.$5p,e),o.md(e.$6p,e),o.addHierarchyChangeListener(e.handleHierarchyChange,e),o.addIndexChangeListener(e.handleIndexChange,e)),e.fp("dataModel",l,o),e.clear())},setHistoryIndex:function(Y,C){var B=this,m=B._historyIndex,W=B._histories.length;if(-1>Y?Y=-1:Y>=W&&(Y=W-1),m!==Y){if(!C){var p=Y-m;p>0?B.$2p(p):0>p&&B.$1p(-p)}B._historyIndex=Y,B.fp("historyIndex",m,Y),B.dataModel&&B.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(O){var B=this,m=B._histories,K=B._maxHistoryCount;(!O||0>=O)&&(O=10),K!==O&&(B._maxHistoryCount=O,B.fp("maxHistoryCount",K,O),m.length>O&&B.clear())},cloneValue:function(e){return m.Default.clone(e)},isPropertyUndoable:function(s){return s&&!this.ignoredPropertyMap[s]},isDataModelPropertyUndoable:function(y){return y&&!this.ignoreDataModelPropertyMap[y]},$5p:function(l){this.handleChange(l,l.kind)},$6p:function(y){this.handleChange(y,"property")},handleHierarchyChange:function(W){this.handleChange(W,"hierarchy")},handleIndexChange:function(j){this.handleChange(j,"index")},handleDataModelPropertyChange:function(B){this.handleChange(B,"dataModelProperty")},toChildrenInfo:function(G){var C={};return C.data=G,C.children=[],G.eachChild(function(D){C.children.push(this.toChildrenInfo(D))},this),C},restoreChildren:function(G){var d=G.data;G.children.forEach(function(n){var r=n.data;r.getParent()!==d&&d.addChild(r),this._dataModel.contains(r)||this._dataModel.add(r),this.restoreChildren(n)},this)},handleChange:function(d,D){var J=this;if(!(J._disabled||J._isUndoRedoing||T.loadingRefGraph)){var K,j=(J._histories,d.data),u=d.property;if(!j||!(j._refGraph||j instanceof m.RefGraph)){if("property"===D)J.isPropertyUndoable(u,j)&&(K={kind:D,data:j,property:u,oldValue:J.cloneValue(d.oldValue,j,u),newValue:J.cloneValue(d.newValue,j,u),event:d});else if("hierarchy"===D||"index"===D)K={kind:D,data:j,oldIndex:d.oldIndex,newIndex:d.newIndex,event:d};else if("clear"===D)K={kind:D,json:d.json,event:d};else if("add"===D){if(K={kind:D,data:j,event:d,childrenInfo:this.toChildrenInfo(j),parent:j.getParent()},K.parent){var v=J._dataModel.getSiblings(j);K.siblingsIndex=v.indexOf(j)}j instanceof m.Node&&(K.host=j.getHost(),K.attaches=j.getAttaches()?j.getAttaches().toArray():g),j instanceof m.Edge&&(K.source=j.getSource(),K.target=j.getTarget())}else"remove"===D?K={kind:D,data:j,event:d}:"dataModelProperty"===D&&J.isDataModelPropertyUndoable(u,j)&&(K={kind:D,property:u,oldValue:J.cloneValue(d.oldValue,j,u),newValue:J.cloneValue(d.newValue,j,u),event:d});J.addHistory(K)}}},addHistory:function(v){var j=this;if(v)if(j._betweenTransaction){var w=!1;if("property"===v.kind||"dataModelProperty"===v.kind)for(var h=j._transactionHistories.length-1;h>=0;h--){var I=j._transactionHistories[h];if(v.kind===I.kind&&v.property===I.property&&v.data===I.data){v.oldValue=I.oldValue,j._transactionHistories[h]=v,w=!0;break}}w||j._transactionHistories.push(v)}else{var y=j._histories;y=y.slice(0,j._historyIndex+1),y.push([v]),y.length>j._maxHistoryCount&&(y=y.slice(y.length-j._maxHistoryCount)),j.setHistories(y),j.setHistoryIndex(y.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function($){(!$||0>=$)&&($=1),this.setHistoryIndex(this._historyIndex-$)},$1p:function(y){if(this.canUndo()){var l,m=this,B=m._dataModel,i=m._histories,x=m._historyIndex,Q=0;for(m._isUndoRedoing=!0,T.setIsolating(!0);y>0;){if(x>=0&&x<i.length){Q++,l=i[x],x--;for(var D=l.length-1;D>=0;D--){var k=l[D],f=k.kind,O=k.data,g=k.property,p=k.event,M=this.cloneValue(k.oldValue,O,g);if(k.undo)k.undo();else if("add"===f)B.remove(O,{keepChildren:!0});else if("remove"===f)B.contains(O)||B.add(O,p.rootsIndex,p.datasIndex);else if("clear"===f)B.deserialize(T.clone(k.json));else if("property"===f)if("parent"===g)M?M.addChild(O,p.oldIndex):(O.setParent(M),p.oldIndex>=0&&B.moveTo(O,p.oldIndex));else{var S=null;0===g.indexOf("a:")?(S="attr",g=g.replace("a:","")):0===g.indexOf("s:")?(S="style",g=g.replace("s:","")):0===g.indexOf("f:")&&(S="field",g=g.replace("f:","")),$.setPropertyValue(O,S,g,M)}else if("dataModelProperty"===f){var S=null;0===g.indexOf("a:")?(S="attr",g=g.replace("a:","")):0===g.indexOf("s:")?(S="style",g=g.replace("s:","")):0===g.indexOf("f:")&&(S="field",g=g.replace("f:","")),$.setPropertyValue(B,S,g,M)}else"hierarchy"===f?B.moveTo(O,k.oldIndex):"index"===f&&B.moveToIndex(O,k.oldIndex)}}y--}T.setIsolating(!1),delete m._isUndoRedoing,m.afterUndo(Q)}},afterUndo:function(){},redo:function(C){(!C||0>=C)&&(C=1),this.setHistoryIndex(this._historyIndex+C)},$2p:function(O){if(this.canRedo()){var Z,P=this,S=P._dataModel,p=P._histories,I=P._historyIndex,F=0;for(P._isUndoRedoing=!0,T.setIsolating(!0);O>0;){if(I>=-1&&I<p.length-1){F++,I++,Z=p[I];for(var a=0;a<Z.length;a++){var D=Z[a],G=D.kind,A=D.data,R=D.property,V=D.event,n=this.cloneValue(D.newValue,A,R);if(D.redo)D.redo();else if("add"===G)D.parent&&!A.getParent()&&D.parent.addChild(A,D.siblingsIndex),S.contains(A)||S.add(A,V.rootsIndex,V.datasIndex),this.restoreChildren(D.childrenInfo),A instanceof m.Node&&(A.setHost(D.host),D.attaches&&D.attaches.forEach(function(M){M.setHost(A)})),A instanceof m.Edge&&(A.setSource(D.source),A.setTarget(D.target));else if("remove"===G)S.remove(A);else if("clear"===G)S.clear();else if("property"===G)if("parent"===R)n?n.addChild(A,V.newIndex):(A.setParent(n),V.newIndex>=0&&S.moveTo(A,V.newIndex));else{var h=null;0===R.indexOf("a:")?(h="attr",R=R.replace("a:","")):0===R.indexOf("s:")?(h="style",R=R.replace("s:","")):0===R.indexOf("f:")&&(h="field",R=R.replace("f:","")),$.setPropertyValue(A,h,R,n)}else if("dataModelProperty"===G){var h=null;0===R.indexOf("a:")?(h="attr",R=R.replace("a:","")):0===R.indexOf("s:")?(h="style",R=R.replace("s:","")):0===R.indexOf("f:")&&(h="field",R=R.replace("f:","")),$.setPropertyValue(S,h,R,n)}else"hierarchy"===G?S.moveTo(A,D.newIndex):"index"===G&&S.moveToIndex(A,D.newIndex)}}O--}T.setIsolating(!1),delete P._isUndoRedoing,this.afterRedo(F)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);